# PR è‡ªåŠ¨å®¡æŸ¥ - è¯­æ³•æ£€æŸ¥ + AI è¯­ä¹‰å®¡æŸ¥
# å½“æœ‰ PR åˆ›å»ºæˆ–æ›´æ–°æ—¶è‡ªåŠ¨è§¦å‘

name: PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

# é™åˆ¶å¹¶å‘ï¼Œé¿å…åŒä¸€ PR å¤šæ¬¡è§¦å‘æ—¶é‡å¤è¯„è®º
concurrency:
  group: pr-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  # ==================== é™æ€æ£€æŸ¥ï¼ˆå…ˆäº AI å®¡æŸ¥ï¼‰====================
  auto-check:
    name: ğŸ” é™æ€æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      syntax_ok: ${{ steps.syntax.outputs.syntax_ok }}
      has_py_changes: ${{ steps.check_files.outputs.has_py_changes }}
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”„ è·å– base åˆ†æ”¯
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || true
          pip install flake8
      
      - name: ğŸ“‹ æ£€æŸ¥å˜æ›´æ–‡ä»¶
        id: check_files
        run: |
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- '*.py' 2>/dev/null || echo "")
          if [ -z "$CHANGED_FILES" ]; then
            echo "has_py_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… æ²¡æœ‰ä¿®æ”¹ Python æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_py_changes=true" >> $GITHUB_OUTPUT
            echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
            echo "$CHANGED_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
      
      - name: ğŸ Python è¯­æ³•æ£€æŸ¥
        id: syntax
        if: steps.check_files.outputs.has_py_changes == 'true'
        run: |
          echo "## ğŸ è¯­æ³•æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "æ£€æŸ¥æ–‡ä»¶: $CHANGED_FILES"
          
          ERRORS=""
          SYNTAX_OK="true"
          for file in $CHANGED_FILES; do
            if [ -f "$file" ]; then
              if ! python -m py_compile "$file" 2>&1; then
                ERRORS="$ERRORS\nâŒ $file è¯­æ³•é”™è¯¯"
                SYNTAX_OK="false"
              fi
            fi
          done
          
          echo "syntax_ok=$SYNTAX_OK" >> $GITHUB_OUTPUT
          
          if [ "$SYNTAX_OK" = "false" ]; then
            echo -e "$ERRORS" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "âœ… æ‰€æœ‰æ–‡ä»¶è¯­æ³•æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ” Flake8 æ£€æŸ¥ï¼ˆä¸¥é‡é”™è¯¯ï¼‰
        if: steps.check_files.outputs.has_py_changes == 'true'
        continue-on-error: true
        run: |
          echo "## ğŸ” ä»£ç è´¨é‡æ£€æŸ¥" >> $GITHUB_STEP_SUMMARY
          
          # åªæ£€æŸ¥ä¸¥é‡é”™è¯¯
          RESULT=$(flake8 $CHANGED_FILES --select=E9,F63,F7,F82 --format='%(path)s:%(row)d: %(code)s %(text)s' 2>/dev/null || true)
          
          if [ -n "$RESULT" ]; then
            echo "âš ï¸ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$RESULT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… æœªå‘ç°ä¸¥é‡ä»£ç é—®é¢˜" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: ğŸ“Š å˜æ›´ç»Ÿè®¡
        run: |
          echo "## ğŸ“Š å˜æ›´ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STATS=$(git diff --stat origin/${{ github.base_ref }}...HEAD 2>/dev/null | tail -1)
          echo "$STATS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ä¿®æ”¹çš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          git diff --name-status origin/${{ github.base_ref }}...HEAD 2>/dev/null | while read status file; do
            case $status in
              A) echo "- ğŸ†• \`$file\` (æ–°å¢)" >> $GITHUB_STEP_SUMMARY ;;
              M) echo "- ğŸ“ \`$file\` (ä¿®æ”¹)" >> $GITHUB_STEP_SUMMARY ;;
              D) echo "- ğŸ—‘ï¸ \`$file\` (åˆ é™¤)" >> $GITHUB_STEP_SUMMARY ;;
              *) echo "- ğŸ“„ \`$file\`" >> $GITHUB_STEP_SUMMARY ;;
            esac
          done

  # ==================== AI ä»£ç å®¡æŸ¥ï¼ˆä¾èµ–é™æ€æ£€æŸ¥é€šè¿‡ï¼‰====================
  ai-review:
    name: ğŸ¤– AI ä»£ç å®¡æŸ¥
    runs-on: ubuntu-latest
    needs: [auto-check]
    # ä»…å½“ï¼š1. é™æ€æ£€æŸ¥é€šè¿‡ 2. æœ‰ Python æ–‡ä»¶å˜æ›´ 3. æœªç¦ç”¨ AI å®¡æŸ¥
    if: |
      needs.auto-check.result == 'success' &&
      needs.auto-check.outputs.has_py_changes == 'true' &&
      vars.ENABLE_AI_REVIEW != 'false'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ”„ è·å– base åˆ†æ”¯
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}
      
      - name: ğŸ è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install google-genai openai httpx
      
      - name: ğŸ¤– AI å®¡æŸ¥ä»£ç å˜æ›´
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
        run: |
          python << 'EOF'
          import os
          import subprocess

          MAX_DIFF_LENGTH = 15000

          def get_diff():
              """è·å– PR çš„ä»£ç å˜æ›´"""
              base_ref = os.environ.get('GITHUB_BASE_REF', 'main')
              result = subprocess.run(
                  ['git', 'diff', f'origin/{base_ref}...HEAD', '--', '*.py'],
                  capture_output=True, text=True
              )
              diff = result.stdout
              truncated = len(diff) > MAX_DIFF_LENGTH
              return diff[:MAX_DIFF_LENGTH], truncated

          def get_changed_files():
              """è·å–ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨"""
              base_ref = os.environ.get('GITHUB_BASE_REF', 'main')
              result = subprocess.run(
                  ['git', 'diff', '--name-only', f'origin/{base_ref}...HEAD', '--', '*.py'],
                  capture_output=True, text=True
              )
              return result.stdout.strip().split('\n') if result.stdout.strip() else []

          def build_prompt(diff_content, files, truncated):
              """æ„å»ºå®¡æŸ¥æç¤ºè¯"""
              truncate_notice = ""
              if truncated:
                  truncate_notice = "\n\n> âš ï¸ æ³¨æ„ï¼šç”±äºå˜æ›´å†…å®¹è¿‡é•¿ï¼Œdiff å·²è¢«æˆªæ–­ï¼Œè¯·åŸºäºå¯è§éƒ¨åˆ†è¿›è¡Œå®¡æŸ¥ã€‚\n"
              
              # æ£€æµ‹æ ¸å¿ƒæ–‡ä»¶å˜æ›´
              core_files = [f for f in files if f in ['main.py', 'config.py', 'analyzer.py', 'notification.py']]
              core_notice = ""
              if core_files:
                  core_notice = f"\n\n> ğŸ”” **æ ¸å¿ƒæ–‡ä»¶å˜æ›´**: {', '.join(core_files)}ï¼Œè¯·é‡ç‚¹å®¡æŸ¥ï¼\n"
              
              return f"""ä½ æ˜¯ä¸€ä½èµ„æ·± Python ä»£ç å®¡æŸ¥ä¸“å®¶ã€‚è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼Œå¹¶ç»™å‡ºä¸“ä¸šçš„å®¡æŸ¥æ„è§ã€‚

## ä¿®æ”¹çš„æ–‡ä»¶
{', '.join(files)}{core_notice}{truncate_notice}

## ä»£ç å˜æ›´ (diff)
```diff
{diff_content}
```

## å®¡æŸ¥è¦æ±‚
è¯·ä»ä»¥ä¸‹ç»´åº¦è¿›è¡Œå®¡æŸ¥ï¼Œä½¿ç”¨ä¸­æ–‡å›å¤ï¼š

1. **ğŸ”’ å®‰å…¨æ€§**: æ˜¯å¦å­˜åœ¨å®‰å…¨æ¼æ´ï¼ˆå¦‚ SQL æ³¨å…¥ã€æ•æ„Ÿä¿¡æ¯æ³„éœ²ç­‰ï¼‰
2. **ğŸ› æ½œåœ¨ Bug**: æ˜¯å¦æœ‰é€»è¾‘é”™è¯¯ã€è¾¹ç•Œæ¡ä»¶æœªå¤„ç†ã€å¼‚å¸¸æœªæ•è·
3. **âš¡ æ€§èƒ½**: æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜ï¼ˆå¦‚ä¸å¿…è¦çš„å¾ªç¯ã€å†…å­˜æ³„æ¼é£é™©ï¼‰
4. **ğŸ“– å¯è¯»æ€§**: ä»£ç æ˜¯å¦æ¸…æ™°æ˜“æ‡‚ï¼Œå‘½åæ˜¯å¦è§„èŒƒ
5. **ğŸ—ï¸ æ¶æ„è®¾è®¡**: æ˜¯å¦ç¬¦åˆé¡¹ç›®æ¶æ„ï¼Œæœ‰æ— æ›´å¥½çš„å®ç°æ–¹å¼

## è¾“å‡ºæ ¼å¼
- å¦‚æœä»£ç è´¨é‡è‰¯å¥½ï¼Œç®€è¦è¯´æ˜ä¼˜ç‚¹
- å¦‚æœå‘ç°é—®é¢˜ï¼Œåˆ—å‡ºå…·ä½“é—®é¢˜å’Œæ”¹è¿›å»ºè®®
- ç»™å‡ºæ€»ä½“è¯„ä»·ï¼šâœ… å»ºè®®åˆå…¥ / âš ï¸ å»ºè®®ä¿®æ”¹ååˆå…¥ / âŒ éœ€è¦é‡å¤§ä¿®æ”¹

è¯·ä¿æŒç®€æ´ï¼Œé‡ç‚¹çªå‡ºã€‚"""

          def review_with_gemini(prompt):
              """ä½¿ç”¨ Gemini API è¿›è¡Œå®¡æŸ¥"""
              api_key = os.environ.get('GEMINI_API_KEY')
              model = os.environ.get('GEMINI_MODEL_FALLBACK', 'gemini-2.5-flash')
              
              if not api_key:
                  print("Gemini API Key æœªé…ç½®")
                  return None
              
              try:
                  from google import genai
                  client = genai.Client(api_key=api_key)
                  response = client.models.generate_content(
                      model=model,
                      contents=prompt
                  )
                  print(f"âœ… Gemini ({model}) å®¡æŸ¥æˆåŠŸ")
                  return response.text
              except Exception as e:
                  print(f"âŒ Gemini å®¡æŸ¥å¤±è´¥: {e}")
                  return None

          def review_with_openai(prompt):
              """ä½¿ç”¨ OpenAI å…¼å®¹ API è¿›è¡Œå®¡æŸ¥ï¼ˆå¤‡ç”¨ï¼‰"""
              api_key = os.environ.get('OPENAI_API_KEY')
              base_url = os.environ.get('OPENAI_BASE_URL', 'https://api.openai.com/v1')
              model = os.environ.get('OPENAI_MODEL', 'gpt-4o-mini')
              
              if not api_key:
                  print("OpenAI API Key æœªé…ç½®")
                  return None
              
              try:
                  from openai import OpenAI
                  client = OpenAI(api_key=api_key, base_url=base_url)
                  response = client.chat.completions.create(
                      model=model,
                      messages=[{"role": "user", "content": prompt}],
                      max_tokens=2000,
                      temperature=0.3
                  )
                  print(f"âœ… OpenAI å…¼å®¹æ¥å£ ({model}) å®¡æŸ¥æˆåŠŸ")
                  return response.choices[0].message.content
              except Exception as e:
                  print(f"âŒ OpenAI å…¼å®¹æ¥å£å®¡æŸ¥å¤±è´¥: {e}")
                  return None

          def ai_review(diff_content, files, truncated):
              """è°ƒç”¨ AI è¿›è¡Œä»£ç å®¡æŸ¥ï¼Œä¼˜å…ˆ Geminiï¼Œå¤±è´¥åå°è¯• OpenAI"""
              prompt = build_prompt(diff_content, files, truncated)
              
              # 1. ä¼˜å…ˆå°è¯• Gemini
              result = review_with_gemini(prompt)
              if result:
                  return result
              
              # 2. Gemini å¤±è´¥ï¼Œå°è¯• OpenAI å…¼å®¹æ¥å£
              print("å°è¯•ä½¿ç”¨ OpenAI å…¼å®¹æ¥å£...")
              result = review_with_openai(prompt)
              if result:
                  return result
              
              return None

          def main():
              diff, truncated = get_diff()
              files = get_changed_files()
              
              if not diff or not files:
                  print("æ²¡æœ‰ Python ä»£ç å˜æ›´ï¼Œè·³è¿‡ AI å®¡æŸ¥")
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write("## ğŸ¤– AI ä»£ç å®¡æŸ¥\n\nâœ… æ²¡æœ‰ Python ä»£ç å˜æ›´\n")
                  return
              
              print(f"å®¡æŸ¥æ–‡ä»¶: {files}")
              if truncated:
                  print(f"âš ï¸ Diff å†…å®¹å·²æˆªæ–­è‡³ {MAX_DIFF_LENGTH} å­—ç¬¦")
              
              review = ai_review(diff, files, truncated)
              
              if review:
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write(f"## ğŸ¤– AI ä»£ç å®¡æŸ¥\n\n{review}\n")
                  
                  with open('ai_review_result.txt', 'w') as f:
                      f.write(review)
                  
                  print("AI å®¡æŸ¥å®Œæˆ")
              else:
                  print("âš ï¸ æ‰€æœ‰ AI æ¥å£éƒ½ä¸å¯ç”¨")
                  with open(os.environ['GITHUB_STEP_SUMMARY'], 'a') as f:
                      f.write("## ğŸ¤– AI ä»£ç å®¡æŸ¥\n\nâš ï¸ AI æ¥å£ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®\n")

          if __name__ == '__main__':
              main()
          EOF
      
      - name: ğŸ“¤ ä¸Šä¼ å®¡æŸ¥ç»“æœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ai-review-result
          path: ai_review_result.txt
          if-no-files-found: ignore

  # ==================== PR æ ‡ç­¾è‡ªåŠ¨åˆ†ç±» ====================
  labeler:
    name: ğŸ·ï¸ è‡ªåŠ¨æ ‡ç­¾
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: ğŸ·ï¸ æ·»åŠ æ ‡ç­¾
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const labels = new Set();
            
            for (const file of files) {
              const filename = file.filename.toLowerCase();
              
              // æ ¹æ®æ–‡ä»¶è·¯å¾„æ·»åŠ æ ‡ç­¾
              if (filename.includes('notification') || filename.includes('webhook')) {
                labels.add('notification');
              }
              if (filename.includes('feishu')) {
                labels.add('feishu');
              }
              if (filename.includes('data_provider') || filename.includes('fetcher')) {
                labels.add('data-source');
              }
              if (filename.includes('analyzer') || filename.includes('ai')) {
                labels.add('ai');
              }
              if (filename.endsWith('.md') || filename.includes('doc')) {
                labels.add('documentation');
              }
              if (filename.includes('workflow') || filename.includes('.github')) {
                labels.add('ci/cd');
              }
              if (filename.includes('config')) {
                labels.add('configuration');
              }
              if (filename.includes('test')) {
                labels.add('testing');
              }
            }
            
            // æ ¹æ®å˜æ›´å¤§å°æ·»åŠ æ ‡ç­¾
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const totalChanges = additions + deletions;
            
            if (totalChanges < 50) {
              labels.add('size/S');
            } else if (totalChanges < 200) {
              labels.add('size/M');
            } else if (totalChanges < 500) {
              labels.add('size/L');
            } else {
              labels.add('size/XL');
            }
            
            // æ·»åŠ æ ‡ç­¾
            if (labels.size > 0) {
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: Array.from(labels)
                });
                console.log(`Added labels: ${Array.from(labels).join(', ')}`);
              } catch (e) {
                console.log(`Failed to add labels: ${e.message}`);
              }
            }

  # ==================== è‡ªåŠ¨è¯„è®ºæ£€æŸ¥ç»“æœ ====================
  comment:
    name: ğŸ’¬ å®¡æŸ¥æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [auto-check, ai-review]
    if: always()
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ“¥ ä¸‹è½½ AI å®¡æŸ¥ç»“æœ
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: ai-review-result
          path: .
      
      - name: ğŸ’¬ ç”Ÿæˆå®¡æŸ¥æŠ¥å‘Š
        env:
          AUTO_CHECK_RESULT: ${{ needs.auto-check.result }}
          AI_REVIEW_RESULT: ${{ needs.ai-review.result }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // è·å– PR ä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // è·å–ä¿®æ”¹çš„æ–‡ä»¶
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const additions = files.reduce((sum, f) => sum + f.additions, 0);
            const deletions = files.reduce((sum, f) => sum + f.deletions, 0);
            const changedFiles = files.length;
            
            // è¯»å– AI å®¡æŸ¥ç»“æœ
            let aiReview = '';
            try {
              aiReview = fs.readFileSync('ai_review_result.txt', 'utf8');
            } catch (e) {
              console.log('No AI review result found');
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°è¯„è®ºï¼ˆé¿å…é‡å¤è¯„è®ºï¼‰
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('## ğŸ¤– è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š')
            );
            
            // é€šè¿‡ env è·å–çŠ¶æ€ï¼Œé¿å…å˜é‡æ’å€¼é—®é¢˜
            const checkStatus = process.env.AUTO_CHECK_RESULT === 'success' ? 'âœ… é€šè¿‡' : 'âš ï¸ æœ‰é—®é¢˜';
            const aiStatus = process.env.AI_REVIEW_RESULT === 'success' ? 'âœ… å·²å®Œæˆ' : 
                            process.env.AI_REVIEW_RESULT === 'skipped' ? 'â­ï¸ è·³è¿‡' : 'âš ï¸ å¤±è´¥';
            
            let report = `## ğŸ¤– è‡ªåŠ¨å®¡æŸ¥æŠ¥å‘Š

| é¡¹ç›® | ç»“æœ |
|------|------|
| ğŸ“Š å˜æ›´æ–‡ä»¶ | ${changedFiles} ä¸ª |
| â• æ–°å¢è¡Œæ•° | ${additions} è¡Œ |
| â– åˆ é™¤è¡Œæ•° | ${deletions} è¡Œ |
| ğŸ” é™æ€æ£€æŸ¥ | ${checkStatus} |
| ğŸ§  AI å®¡æŸ¥ | ${aiStatus} |

### ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

`;
            
            for (const file of files.slice(0, 20)) {
              const status = file.status === 'added' ? 'ğŸ†•' : 
                            file.status === 'removed' ? 'ğŸ—‘ï¸' : 'ğŸ“';
              report += `- ${status} \`${file.filename}\` (+${file.additions}/-${file.deletions})\n`;
            }
            
            if (files.length > 20) {
              report += `\n... è¿˜æœ‰ ${files.length - 20} ä¸ªæ–‡ä»¶\n`;
            }
            
            // æ·»åŠ  AI å®¡æŸ¥ç»“æœ
            if (aiReview) {
              report += `
---

### ğŸ§  AI ä»£ç å®¡æŸ¥æ„è§

${aiReview}
`;
            }
            
            report += `
---

> ğŸ’¡ **æç¤º**: è¯·ç¡®ä¿ä»£ç å·²é€šè¿‡æœ¬åœ°æµ‹è¯•ï¼Œå¹¶éµå¾ªé¡¹ç›®ä»£ç è§„èŒƒã€‚
> 
> æŸ¥çœ‹ [CI æ£€æŸ¥è¯¦æƒ…](${context.payload.pull_request.html_url}/checks) è·å–æ›´å¤šä¿¡æ¯ã€‚
`;
            
            // æ›´æ–°æˆ–åˆ›å»ºè¯„è®º
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
              console.log('Updated existing comment');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
              console.log('Created new comment');
            }
